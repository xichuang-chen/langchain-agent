# Feature
ä¸ºchat agent æä¾›long memory åŠŸèƒ½

# ç¤ºä¾‹
### Old world

```
ç”¨æˆ·: æˆ‘å–œæ¬¢å’–å•¡
Agent: å’–å•¡æ˜¯ä¸€ç§å—æ¬¢è¿çš„é¥®å“ï¼Œè®¸å¤šäººå–œæ¬¢å®ƒçš„é¦™æ°”å’Œæç¥æ•ˆæœã€‚ä½ å–œæ¬¢å“ªç§ç±»å‹çš„å’–å•¡å‘¢ï¼Ÿæ¯”å¦‚æµ“ç¼©å’–å•¡ã€æ‹¿é“ã€å¡å¸ƒå¥‡è¯ºï¼Œè¿˜æ˜¯å…¶ä»–çš„ï¼Ÿ
ç”¨æˆ·ï¼šæˆ‘æ˜¯å°é€¸ï¼Œæˆ‘å–œæ¬¢æ‹¿é“
Agent: åŸæ¥ä½ æ˜¯å°é€¸å‘€ğŸ˜Šï¼Œå–œæ¬¢çƒ­çš„æ‹¿é“ç¡®å®å¾ˆæ¸©æš–åˆé¦™é†‡ã€‚æ‹¿é“çš„å¥¶é¦™å’Œå’–å•¡çš„æµ“é¦™èåˆåœ¨ä¸€èµ·ï¼Œéå¸¸é€‚åˆæ…¢æ…¢å“å‘³ã€‚ä½ ä¸€èˆ¬å–œæ¬¢åœ¨ä»€ä¹ˆæ—¶é—´å–çƒ­æ‹¿é“å‘¢ï¼Ÿæ˜¯æ—©æ™¨æç¥ï¼Œè¿˜æ˜¯ä¸‹åˆå°æ†©çš„æ—¶å€™ï¼Ÿ

stop the agent.
npm run start again.

ç”¨æˆ·: ä½ è¿˜è®°å¾—æˆ‘æ˜¯è°ï¼Œå–œæ¬¢ä»€ä¹ˆå—
Agent: æˆ‘ç°åœ¨å¹¶ä¸èƒ½è®°ä½ä½ ä¹‹å‰è·Ÿæˆ‘è¯´è¿‡çš„è¯ï¼Œä¹Ÿä¸äº†è§£ä½ è¿‡å»çš„å–œå¥½æˆ–èº«ä»½ä¿¡æ¯ã€‚  \nä¸è¿‡ä½ å¯ä»¥å‘Šè¯‰æˆ‘ä½ æ˜¯è°ã€ä½ å–œæ¬¢ä»€ä¹ˆï¼Œæˆ‘å¯ä»¥æ ¹æ®ä½ æä¾›çš„ä¿¡æ¯æ¥å’Œä½ äº¤æµï¼Œå¹¶åœ¨è¿™æ¬¡å¯¹è¯ä¸­è®°ä½å®ƒã€‚  \n\nä½ æ„¿æ„å…ˆè·Ÿæˆ‘åˆ†äº«ä¸€ä¸‹ä½ çš„å…´è¶£çˆ±å¥½å—ï¼Ÿ

```
### New world
```
ç”¨æˆ·: æˆ‘å–œæ¬¢å’–å•¡
Agent: å’–å•¡æ˜¯ä¸€ç§å—æ¬¢è¿çš„é¥®å“ï¼Œè®¸å¤šäººå–œæ¬¢å®ƒçš„é¦™æ°”å’Œæç¥æ•ˆæœã€‚ä½ å–œæ¬¢å“ªç§ç±»å‹çš„å’–å•¡å‘¢ï¼Ÿæ¯”å¦‚æµ“ç¼©å’–å•¡ã€æ‹¿é“ã€å¡å¸ƒå¥‡è¯ºï¼Œè¿˜æ˜¯å…¶ä»–çš„ï¼Ÿ
ç”¨æˆ·ï¼šæˆ‘æ˜¯å°é€¸ï¼Œæˆ‘å–œæ¬¢æ‹¿é“
Agent: åŸæ¥ä½ æ˜¯å°é€¸å‘€ğŸ˜Šï¼Œå–œæ¬¢çƒ­çš„æ‹¿é“ç¡®å®å¾ˆæ¸©æš–åˆé¦™é†‡ã€‚æ‹¿é“çš„å¥¶é¦™å’Œå’–å•¡çš„æµ“é¦™èåˆåœ¨ä¸€èµ·ï¼Œéå¸¸é€‚åˆæ…¢æ…¢å“å‘³ã€‚ä½ ä¸€èˆ¬å–œæ¬¢åœ¨ä»€ä¹ˆæ—¶é—´å–çƒ­æ‹¿é“å‘¢ï¼Ÿæ˜¯æ—©æ™¨æç¥ï¼Œè¿˜æ˜¯ä¸‹åˆå°æ†©çš„æ—¶å€™ï¼Ÿ

stop the agent.
npm run start again.

ç”¨æˆ·: ä½ è¿˜è®°å¾—æˆ‘æ˜¯è°ï¼Œå–œæ¬¢ä»€ä¹ˆå—
Agent: å½“ç„¶è®°å¾—å‘€ğŸ˜Š  \nä½ æ˜¯ **å°é€¸**ï¼Œå–œæ¬¢ **çƒ­å’–å•¡**ï¼Œå°¤å…¶æ˜¯ **æ‹¿é“**ã€‚  \næ‹¿é“çš„å¥¶é¦™å’Œå’–å•¡çš„æµ“é¦™èåˆåœ¨ä¸€èµ·ï¼Œéå¸¸é€‚åˆæ…¢æ…¢å“å‘³ã€‚  \n\nä½ æƒ³è®©æˆ‘å¸®ä½ æ¨èå‡ æ¬¾é€‚åˆä½ å£å‘³çš„æ‹¿é“ç‰¹åˆ«é…æ–¹å—ï¼Ÿ
ç”¨æˆ·: ä½ è¿˜è®°å¾—æˆ‘å–œæ¬¢ä»€ä¹ˆåŠ¨ç‰©å—
Agent: è®°å¾—å‘€ğŸ¶  \nä½ å–œæ¬¢ **å°ç‹—**ï¼Œè§‰å¾—å®ƒä»¬çš„é™ªä¼´æ¸©æš–åˆæ²»æ„ˆã€‚  \n\nä½ æ˜¯å–œæ¬¢æ´»æ³¼å¥½åŠ¨çš„å“ç§ï¼Œæ¯”å¦‚æŸ¯åŸºã€æ‹‰å¸ƒæ‹‰å¤šï¼Œè¿˜æ˜¯ä¹–å·§é»äººçš„ï¼Œæ¯”å¦‚åšç¾ã€é©¬å°”æµæ–¯å‘¢ï¼Ÿ
```

# é‡åˆ°çš„é—®é¢˜

## 1. å½“æˆ‘é—®çš„é—®é¢˜è§¦å‘äº†Azure/LiteLLM çš„ Content Policyæ—¶ï¼Œä¼šæŠ¥é”™


<details>

<summary>å±•å¼€æŸ¥çœ‹é”™è¯¯ä¿¡æ¯æ‘˜è¦</summary> 

```
agent/node_modules/@langchain/openai/node_modules/openai/src/core/error.ts:72:14)\n    at OpenAI.makeStatusError (/Users/xichuangchen/code/mycode/my-chat-tool/langchain-agent/node_modules/@langchain/openai/node_modules/openai/src/client.ts:445:28)\n    at OpenAI.makeRequest (/Users/xichuangchen/code/mycode/my-chat-tool/langchain-agent/node_modules/@langchain/openai/node_modules/openai/src/client.ts:668:24)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async file:///Users/xichuangchen/code/mycode/my-chat-tool/langchain-agent/node_modules/@langchain/openai/dist/chat_models.js:2017:28\n    at async RetryOperation._fn (/Users/xichuangchen/code/mycode/my-chat-tool/langchain-agent/node_modules/p-retry/index.js:50:12)"
Agent è§¦å‘äº†ä¸Šæ¸¸å†…å®¹è¿‡æ»¤ï¼ˆAzure/LiteLLM Content Policyï¼‰ã€‚
ä½ å¯ä»¥ï¼š
- æ¢ä¸€ä¸ªå¯ç”¨çš„èŠå¤©æ¨¡å‹/éƒ¨ç½²åï¼šè®¾ç½®ç¯å¢ƒå˜é‡ OPENAI_CHAT_MODEL
- æˆ–è°ƒæ•´ä½ çš„è¾“å…¥/ç³»ç»Ÿæç¤ºè¯åå†è¯•

åŸå§‹é”™è¯¯ï¼š400 litellm.BadRequestError: litellm.ContentPolicyViolationError: litellm.ContentPolicyViolationError: AzureException - The response was filtered due to the prompt triggering Azure OpenAI's content management policy. Please modify your prompt and retry. To learn more about our content filtering policies please read our documentation: https://go.microsoft.com/fwlink/?linkid=2198766
model=gpt-5-chat. content_policy_fallback=None. fallbacks=[{'gpt-4o-2024-08-06': ['gpt-4o-mini-2024-07-18']}, {'gpt-5-2025-08-07': ['gpt-5-chat-2025-08-07', 'gpt-5-mini-2025-08-07']}, {'gpt-5-chat-2025-08-07': ['gpt-5-mini-2025-08-07', 'gpt-5-nano-2025-08-07']}, {'gpt-5-mini-2025-08-07': ['gpt-5-nano-2025-08-07']}, {'gpt-5-high': ['gpt-5-medium', 'gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-medium': ['gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-low': ['gpt-5-minimal']}, {'gpt-5-mini-high': ['gpt-5-mini-medium', 'gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-medium': ['gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-low': ['gpt-5-mini-minimal']}, {'gpt-5-nano-high': ['gpt-5-nano-medium', 'gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-medium': ['gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-low': ['gpt-5-nano-minimal']}, {'claude-sonnet-4-20250514': ['claude-3-7-sonnet-20250219', 'claude-3-5-haiku-20241022']}, {'claude-sonnet-4-5-20250929': ['claude-sonnet-4-20250514', 'claude-haiku-4-5-20251001']}].

Set 'content_policy_fallback' - https://docs.litellm.ai/docs/routing#fallbacksNo fallback model group found for original model_group=gpt-5-chat. Fallbacks=[{'gpt-4o-2024-08-06': ['gpt-4o-mini-2024-07-18']}, {'gpt-5-2025-08-07': ['gpt-5-chat-2025-08-07', 'gpt-5-mini-2025-08-07']}, {'gpt-5-chat-2025-08-07': ['gpt-5-mini-2025-08-07', 'gpt-5-nano-2025-08-07']}, {'gpt-5-mini-2025-08-07': ['gpt-5-nano-2025-08-07']}, {'gpt-5-high': ['gpt-5-medium', 'gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-medium': ['gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-low': ['gpt-5-minimal']}, {'gpt-5-mini-high': ['gpt-5-mini-medium', 'gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-medium': ['gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-low': ['gpt-5-mini-minimal']}, {'gpt-5-nano-high': ['gpt-5-nano-medium', 'gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-medium': ['gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-low': ['gpt-5-nano-minimal']}, {'claude-sonnet-4-20250514': ['claude-3-7-sonnet-20250219', 'claude-3-5-haiku-20241022']}, {'claude-sonnet-4-5-20250929': ['claude-sonnet-4-20250514', 'claude-haiku-4-5-20251001']}]. Received Model Group=gpt-5-chat
Available Model Group Fallbacks=None
Error doing the fallback: litellm.BadRequestError: litellm.ContentPolicyViolationError: litellm.ContentPolicyViolationError: AzureException - The response was filtered due to the prompt triggering Azure OpenAI's content management policy. Please modify your prompt and retry. To learn more about our content filtering policies please read our documentation: https://go.microsoft.com/fwlink/?linkid=2198766
model=gpt-5-chat. content_policy_fallback=None. fallbacks=[{'gpt-4o-2024-08-06': ['gpt-4o-mini-2024-07-18']}, {'gpt-5-2025-08-07': ['gpt-5-chat-2025-08-07', 'gpt-5-mini-2025-08-07']}, {'gpt-5-chat-2025-08-07': ['gpt-5-mini-2025-08-07', 'gpt-5-nano-2025-08-07']}, {'gpt-5-mini-2025-08-07': ['gpt-5-nano-2025-08-07']}, {'gpt-5-high': ['gpt-5-medium', 'gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-medium': ['gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-low': ['gpt-5-minimal']}, {'gpt-5-mini-high': ['gpt-5-mini-medium', 'gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-medium': ['gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-low': ['gpt-5-mini-minimal']}, {'gpt-5-nano-high': ['gpt-5-nano-medium', 'gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-medium': ['gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-low': ['gpt-5-nano-minimal']}, {'claude-sonnet-4-20250514': ['claude-3-7-sonnet-20250219', 'claude-3-5-haiku-20241022']}, {'claude-sonnet-4-5-20250929': ['claude-sonnet-4-20250514', 'claude-haiku-4-5-20251001']}].

Set 'content_policy_fallback' - https://docs.litellm.ai/docs/routing#fallbacksNo fallback model group found for original model_group=gpt-5-chat. Fallbacks=[{'gpt-4o-2024-08-06': ['gpt-4o-mini-2024-07-18']}, {'gpt-5-2025-08-07': ['gpt-5-chat-2025-08-07', 'gpt-5-mini-2025-08-07']}, {'gpt-5-chat-2025-08-07': ['gpt-5-mini-2025-08-07', 'gpt-5-nano-2025-08-07']}, {'gpt-5-mini-2025-08-07': ['gpt-5-nano-2025-08-07']}, {'gpt-5-high': ['gpt-5-medium', 'gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-medium': ['gpt-5-low', 'gpt-5-minimal']}, {'gpt-5-low': ['gpt-5-minimal']}, {'gpt-5-mini-high': ['gpt-5-mini-medium', 'gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-medium': ['gpt-5-mini-low', 'gpt-5-mini-minimal']}, {'gpt-5-mini-low': ['gpt-5-mini-minimal']}, {'gpt-5-nano-high': ['gpt-5-nano-medium', 'gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-medium': ['gpt-5-nano-low', 'gpt-5-nano-minimal']}, {'gpt-5-nano-low': ['gpt-5-nano-minimal']}, {'claude-sonnet-4-20250514': ['claude-3-7-sonnet-20250219', 'claude-3-5-haiku-20241022']}, {'claude-sonnet-4-5-20250929': ['claude-sonnet-4-20250514', 'claude-haiku-4-5-20251001']}] LiteLLM Retried: 2 times, LiteLLM Max Retries: 3
```
</details>

### åŸå› åˆ†æï¼š  
æ„æ€æ˜¯ï¼š
å‘é€çš„ prompt æˆ–ç³»ç»Ÿæ¶ˆæ¯è§¦å‘äº† Azure OpenAI / LiteLLM çš„å†…å®¹å®‰å…¨ç­–ç•¥

è¯·æ±‚è¢«æ‹’ç»ï¼Œè¿”å› 400 BadRequest

GPT-5-chat æ²¡æœ‰æˆåŠŸç”Ÿæˆå“åº”

**æ—¥å¿—ä¸­å…³é”®ç‚¹**  
- model=gpt-5-chat
- ä½¿ç”¨çš„æ¨¡å‹æ˜¯ GPT-5-chat
- content_policy_fallback=None
- æ²¡æœ‰å¯ç”¨çš„å†…å®¹ç­–ç•¥ fallback æ¨¡å‹
- Fallbacks=[...] LiteLLM å°è¯•è¿‡ä¸€äº›å¤‡é€‰æ¨¡å‹ï¼Œä½†éƒ½æ²¡èƒ½è‡ªåŠ¨åˆ‡æ¢


**è§£å†³åŠæ³•ï¼š**  
æˆ‘ä¹Ÿä¸æ¸…æ¥šä¸ºä»€ä¹ˆ "æˆ‘å–œæ¬¢å’–å•¡" ä¼šè§¦å‘omina gpt-5-chat Azure OpenAI's content management policy  

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªfallback çš„æ¨¡å‹ gpt-5-mini-2025-08-07  

æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆä¸ºï¼Œåœ¨main.ts ä¸­ï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œfallback 

```ts
try {
      const result = await agent.invoke({ input: input.trim() });
      console.log("Agent:", result.output);
    } catch (error) {
      const msg = error instanceof Error ? error.message : String(error);
      if (
        msg.includes("ContentPolicyViolationError") ||
        msg.includes("content management policy") ||
        msg.includes("The response was filtered")
      ) {
        // å¯é€‰ï¼šä½¿ç”¨ fallback æ¨¡å‹è‡ªåŠ¨é‡è¯•ä¸€æ¬¡ï¼ˆå¸¸è§äº LiteLLM/Azure è·¯ç”±æˆ–å†…å®¹è¿‡æ»¤è¯¯åˆ¤ï¼‰
        if (fallbackModel) {
          try {
            agent = await createAgent({ llmModelName: fallbackModel });
            const retry = await agent.invoke({ input: input.trim() });
            console.log("Agent:", retry.output);
            return;
          } catch {
            // fallback ä¹Ÿå¤±è´¥åˆ™èµ°ä¸‹é¢çš„æç¤º
          }
        }
        console.error(
          [
            "Agent è§¦å‘äº†ä¸Šæ¸¸å†…å®¹è¿‡æ»¤ï¼ˆAzure/LiteLLM Content Policyï¼‰ã€‚",
            "ä½ å¯ä»¥ï¼š",
            "- æ¢ä¸€ä¸ªå¯ç”¨çš„èŠå¤©æ¨¡å‹/éƒ¨ç½²åï¼šè®¾ç½®ç¯å¢ƒå˜é‡ OPENAI_CHAT_MODEL",
            "- æˆ–è®¾ç½®ä¸€ä¸ªè‡ªåŠ¨é™çº§æ¨¡å‹ï¼šOPENAI_FALLBACK_CHAT_MODELï¼ˆè§¦å‘è¿‡æ»¤æ—¶ä¼šè‡ªåŠ¨é‡è¯•ä¸€æ¬¡ï¼‰",
            "- æˆ–è°ƒæ•´ä½ çš„è¾“å…¥/ç³»ç»Ÿæç¤ºè¯åå†è¯•",
            "",
            `åŸå§‹é”™è¯¯ï¼š${msg}`,
          ].join("\n")
        );
        return;
      }
      console.error("Agent æ‰§è¡Œå‡ºé”™:", error);
    }
```

## 2. è¿æ¥chromadb é—®é¢˜

é—®é¢˜æè¿°:  
ã€‰ æ— æ³•ä½¿ç”¨æœ¬åœ°æ–‡ä»¶å­˜å‚¨çš„æ–¹å¼ åµŒå…¥å¼ï¼ˆæœ¬åœ°æŒä¹…åŒ–ï¼‰æ–¹æ¡ˆ

åœ¨ Node/TS é‡Œ chromadb åŒ…æœ¬è´¨æ˜¯ HTTP clientï¼Œ@langchain/community çš„ Chroma ä¹Ÿä¼šå»è¿æœåŠ¡ç«¯ï¼›çœŸæ­£â€œembedded + æœ¬åœ°æŒä¹…åŒ–â€æ›´å Python ç”Ÿæ€

è§£å†³æ–¹æ¡ˆ:  
è¿˜æ˜¯æœ¬åœ°å¯åŠ¨äº† chromadbã€‚   
```bash
./scripts/chroma.sh start
```